public with sharing class File {

    // IMPORTANT: DO NOT hardcode Vulnerability__c type
    private static final String VULN_OBJECT_API = 'Vulnerability__c';

    /* ================= ENTRY ================= */
    public static void processNewFiles(List<ContentVersion> contentVersions) {

        Set<Id> contentDocIds = new Set<Id>();

        for (ContentVersion cv : contentVersions) {
            if (cv.ContentDocumentId != null) {
                contentDocIds.add(cv.ContentDocumentId);
            }
        }

        if (!contentDocIds.isEmpty()) {
            importVulnerabilityData(new List<Id>(contentDocIds));
        }
    }

    public static void processNewContentDocuments(Set<Id> contentDocIds) {

        // ‚≠ê‚≠ê‚≠ê ADD THIS LINE (this is the missing piece)
        createScannerReportCases(contentDocIds);

        // üîí EXISTING LOGIC (UNCHANGED)
        importVulnerabilityData(new List<Id>(contentDocIds));
    }


    /* ================= CORE ================= */
    private static void importVulnerabilityData(List<Id> contentDocIds) {

        // 1Ô∏è‚É£ Check object exists (runtime-safe)
        Map<String, Schema.SObjectType> gd = Schema.getGlobalDescribe();
        if (!gd.containsKey(VULN_OBJECT_API)) {
            System.debug('‚ùå Object not found: ' + VULN_OBJECT_API);
            return;
        }

        Schema.SObjectType vulnType = gd.get(VULN_OBJECT_API);

        // 2Ô∏è‚É£ Get latest CSV files
        List<ContentVersion> versions = [
            SELECT Id, VersionData
            FROM ContentVersion
            WHERE ContentDocumentId IN :contentDocIds
            AND IsLatest = true
        ];

        List<SObject> recordsToInsert = new List<SObject>();

        for (ContentVersion cv : versions) {

            if (cv.VersionData == null) continue;

            String csv = cv.VersionData.toString()
                .replace('\r\n', '\n')
                .replace('\r', '\n');

            List<String> rows = csv.split('\n');
            if (rows.size() < 2) continue;

            Map<String, Integer> headerIndex = buildHeaderIndex(rows[0]);

            // 3Ô∏è‚É£ Parse rows
            for (Integer i = 1; i < rows.size(); i++) {

                if (String.isBlank(rows[i])) continue;

                List<String> cols = parseCSVLine(rows[i]);

                String rule = getValue(cols, headerIndex, 'rule');
                String file = getValue(cols, headerIndex, 'file');

                if (String.isBlank(rule) || String.isBlank(file)) continue;

                SObject vuln = vulnType.newSObject();

                // ‚≠ê CORE FIELDS FROM CSV
                vuln.put('Rule__c', rule);
                vuln.put('Engine__c', getValue(cols, headerIndex, 'engine'));
                vuln.put('Severity__c', getValue(cols, headerIndex, 'severity'));
                vuln.put('Category__c', getValue(cols, headerIndex, 'tags'));
                vuln.put('File__c', file);
                vuln.put('Line__c', getValue(cols, headerIndex, 'startline'));
                vuln.put('Column__c', getValue(cols, headerIndex, 'startcolumn'));
                vuln.put('Description__c', getValue(cols, headerIndex, 'message'));
                vuln.put('URL__c', getValue(cols, headerIndex, 'resources'));

                // ‚≠ê CI/CD METADATA
                vuln.put('Commit__c', getValue(cols, headerIndex, 'commitauthor'));
                vuln.put('ActualLine__c', getValue(cols, headerIndex, 'actualline'));
                vuln.put('TargetBranch__c', getValue(cols, headerIndex, 'targetbranch'));

                // ‚≠ê DEFAULT STATUS
                vuln.put('Violation_Status__c', 'Open');

                recordsToInsert.add(vuln);
            }
        }

        // 5Ô∏è‚É£ Insert
        if (!recordsToInsert.isEmpty()) {
            Database.SaveResult[] results = Database.insert(recordsToInsert, false);

            for (Database.SaveResult r : results) {
                if (!r.isSuccess()) {
                    for (Database.Error e : r.getErrors()) {
                        System.debug('‚ùå INSERT ERROR: ' + e.getMessage());
                    }
                }
            }

            System.debug('‚úÖ Insert attempted: ' + recordsToInsert.size());
        } else {
            System.debug('‚ö†Ô∏è No records created from CSV File');
        }
    }

    /* ================= HELPERS ================= */

    private static Map<String, Integer> buildHeaderIndex(String header) {
        Map<String, Integer> indexMap = new Map<String, Integer>();
        List<String> headers = parseCSVLine(header);

        for (Integer i = 0; i < headers.size(); i++) {
            indexMap.put(normalize(headers[i]), i);
        }
        return indexMap;
    }

    private static String getValue(
        List<String> row,
        Map<String, Integer> headerIndex,
        String key
    ) {
        String normalizedKey = normalize(key);
        if (headerIndex.containsKey(normalizedKey)
            && headerIndex.get(normalizedKey) < row.size()) {
            return row[headerIndex.get(normalizedKey)];
        }
        return null;
    }

    private static String normalize(String s) {
        return s == null ? ''
            : s.toLowerCase()
                .replace(' ', '')
                .replace('_', '')
                .replace('-', '');
    }

    // CSV parser (quoted-safe)
    private static List<String> parseCSVLine(String line) {
        List<String> cols = new List<String>();
        Boolean inQuotes = false;
        String cur = '';

        for (Integer i = 0; i < line.length(); i++) {
            String c = line.substring(i, i + 1);
            if (c == '"') {
                inQuotes = !inQuotes;
            } else if (c == ',' && !inQuotes) {
                cols.add(cur.trim());
                cur = '';
            } else {
                cur += c;
            }
        }
        cols.add(cur.trim());
        return cols;
    }

    /* ================= SCANNER REPORT CASE CREATION ================= */
private static void createScannerReportCases(Set<Id> contentDocIds) {

    List<ContentDocument> docs = [
        SELECT Id, Title
        FROM ContentDocument
        WHERE Id IN :contentDocIds
    ];

    List<Scanner_Report_Case__c> casesToInsert = new List<Scanner_Report_Case__c>();

    for (ContentDocument doc : docs) {

        // üî• SAME CONDITION YOU WERE USING
        if (doc.Title != null && doc.Title.contains('Code_Scanner_Report')) {

            // Prevent duplicates
            List<Scanner_Report_Case__c> existing = [
                SELECT Id FROM Scanner_Report_Case__c
                WHERE File_Id__c = :doc.Id LIMIT 1
            ];

            if (!existing.isEmpty()) continue;

            Scanner_Report_Case__c newCase = new Scanner_Report_Case__c();
            newCase.File_Id__c = doc.Id;
            newCase.File_Name__c = doc.Title;
            newCase.Status__c = 'New';
            newCase.OwnerId = UserInfo.getUserId();

            casesToInsert.add(newCase);
        }
    }

    if (!casesToInsert.isEmpty()) {
        insert casesToInsert;
        System.debug('‚úÖ Scanner Report Cases Created: ' + casesToInsert.size());
    }
}

}
