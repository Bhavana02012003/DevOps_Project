name: PR Approval & Merge Tracking

on:
  pull_request_review:
    types: [submitted]

  pull_request:
    types: [opened, reopened, synchronize, closed]

  # Re-run when checks finish (so Open PR record updates after checks complete)
  check_run:
    types: [completed]

  check_suite:
    types: [completed]

permissions:
  contents: read
  pull-requests: read
  checks: read
  actions: read

jobs:
  pr_process:
    runs-on: ubuntu-latest

    env:
      DOMAIN_URL: ${{ vars.SF_DOMAIN_URL }}
      OBJECT_NAME: ${{ vars.SF_OBJECT_NAME }}

      CHECK_NAMES: ${{ vars.CHECK_NAMES }}
      CHECK_ACTION_NAME_FIELDS: ${{ vars.CHECK_ACTION_NAME_FIELDS }}
      CHECK_ACTION_STATUS_FIELDS: ${{ vars.CHECK_ACTION_STATUS_FIELDS }}
      CHECK_ACTION_REPORT_FIELDS: ${{ vars.CHECK_ACTION_REPORT_FIELDS }}

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # ✅ Get PR context for ALL event types (pull_request / review / check_run / check_suite)
      - name: Load PR Context
        id: pr_ctx
        shell: bash
        run: |
          set -euo pipefail

          REPO="${{ github.repository }}"
          TOKEN="${{ secrets.GITHUB_TOKEN }}"

          PR_NUMBER=""

          if [[ "${{ github.event_name }}" == "pull_request" || "${{ github.event_name }}" == "pull_request_review" ]]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          elif [[ "${{ github.event_name }}" == "check_run" ]]; then
            PR_NUMBER=$(echo '${{ toJson(github.event.check_run.check_suite.pull_requests) }}' | jq -r '.[0].number // empty')
          elif [[ "${{ github.event_name }}" == "check_suite" ]]; then
            PR_NUMBER=$(echo '${{ toJson(github.event.check_suite.pull_requests) }}' | jq -r '.[0].number // empty')
          fi

          # If check_run/check_suite is not tied to a PR, do nothing
          if [[ -z "$PR_NUMBER" ]]; then
            echo "No PR context for event: ${{ github.event_name }}. Skipping."
            echo "SKIP=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          PR_JSON=$(curl -sS \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${REPO}/pulls/${PR_NUMBER}")

          MSG=$(echo "$PR_JSON" | jq -r '.message // empty')
          if [[ -n "$MSG" && "$MSG" != "null" ]]; then
            echo "❌ GitHub PR API error: $MSG"
            echo "$PR_JSON"
            exit 1
          fi

          PR_TITLE=$(echo "$PR_JSON" | jq -r '.title')
          PR_LINK=$(echo "$PR_JSON" | jq -r '.html_url')
          PR_AUTHOR=$(echo "$PR_JSON" | jq -r '.user.login')
          PR_STATE=$(echo "$PR_JSON" | jq -r '.state')               # open/closed
          PR_MERGED=$(echo "$PR_JSON" | jq -r '.merged')             # true/false
          PR_MERGED_BY=$(echo "$PR_JSON" | jq -r '.merged_by.login // ""')
          PR_HEAD_SHA=$(echo "$PR_JSON" | jq -r '.head.sha')

          echo "SKIP=false" >> "$GITHUB_OUTPUT"
          echo "PR_NUMBER=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "PR_TITLE=$PR_TITLE" >> "$GITHUB_OUTPUT"
          echo "PR_LINK=$PR_LINK" >> "$GITHUB_OUTPUT"
          echo "PR_AUTHOR=$PR_AUTHOR" >> "$GITHUB_OUTPUT"
          echo "PR_STATE=$PR_STATE" >> "$GITHUB_OUTPUT"
          echo "PR_MERGED=$PR_MERGED" >> "$GITHUB_OUTPUT"
          echo "PR_MERGED_BY=$PR_MERGED_BY" >> "$GITHUB_OUTPUT"
          echo "PR_HEAD_SHA=$PR_HEAD_SHA" >> "$GITHUB_OUTPUT"

      - name: Stop if no PR context
        if: steps.pr_ctx.outputs.SKIP == 'true'
        run: echo "Skipping because event has no PR context."

      - name: Determine PR Status
        if: steps.pr_ctx.outputs.SKIP != 'true'
        id: pr_status_check
        shell: bash
        run: |
          set -euo pipefail

          PR_STATUS="Pending"
          MERGED_BY=""

          prState="${{ steps.pr_ctx.outputs.PR_STATE }}"
          prMerged="${{ steps.pr_ctx.outputs.PR_MERGED }}"
          prMergedBy="${{ steps.pr_ctx.outputs.PR_MERGED_BY }}"

          if [[ "${{ github.event_name }}" == "pull_request_review" ]]; then
            if [[ "${{ github.event.review.state }}" == "approved" ]]; then
              PR_STATUS="Approved"
            elif [[ "${{ github.event.review.state }}" == "changes_requested" ]]; then
              PR_STATUS="Changes Requested"
            else
              PR_STATUS="Review Submitted"
            fi
          else
            if [[ "$prMerged" == "true" ]]; then
              PR_STATUS="Merged"
              MERGED_BY="$prMergedBy"
            else
              if [[ "$prState" == "open" ]]; then
                PR_STATUS="Open"
              else
                PR_STATUS="Closed"
              fi
            fi
          fi

          echo "PR_STATUS=$PR_STATUS" >> "$GITHUB_OUTPUT"
          echo "MERGED_BY=$MERGED_BY" >> "$GITHUB_OUTPUT"

      - name: Fetch check runs + map checks into SF fields (status + artifact)
        if: steps.pr_ctx.outputs.SKIP != 'true'
        id: fetch_checks
        shell: bash
        run: |
          set -euo pipefail

          REPO="${{ github.repository }}"
          SHA="${{ steps.pr_ctx.outputs.PR_HEAD_SHA }}"
          TOKEN="${{ secrets.GITHUB_TOKEN }}"

          CHECK_NAMES_CLEAN=$(echo "${CHECK_NAMES}" | tr -d '\r')
          NAME_FIELDS_CLEAN=$(echo "${CHECK_ACTION_NAME_FIELDS}" | tr -d '\r')
          STATUS_FIELDS_CLEAN=$(echo "${CHECK_ACTION_STATUS_FIELDS}" | tr -d '\r')
          REPORT_FIELDS_CLEAN=$(echo "${CHECK_ACTION_REPORT_FIELDS}" | tr -d '\r')

          if [[ -z "$CHECK_NAMES_CLEAN" || -z "$NAME_FIELDS_CLEAN" || -z "$STATUS_FIELDS_CLEAN" || -z "$REPORT_FIELDS_CLEAN" ]]; then
            echo "❌ One or more GitHub Variables are empty."
            exit 1
          fi

          IFS=',' read -ra CHECK_LIST <<< "$CHECK_NAMES_CLEAN"
          IFS=',' read -ra NAME_FIELDS <<< "$NAME_FIELDS_CLEAN"
          IFS=',' read -ra STATUS_FIELDS <<< "$STATUS_FIELDS_CLEAN"
          IFS=',' read -ra REPORT_FIELDS <<< "$REPORT_FIELDS_CLEAN"

          for i in "${!CHECK_LIST[@]}"; do CHECK_LIST[$i]=$(echo "${CHECK_LIST[$i]}" | xargs); done
          for i in "${!NAME_FIELDS[@]}"; do NAME_FIELDS[$i]=$(echo "${NAME_FIELDS[$i]}" | xargs); done
          for i in "${!STATUS_FIELDS[@]}"; do STATUS_FIELDS[$i]=$(echo "${STATUS_FIELDS[$i]}" | xargs); done
          for i in "${!REPORT_FIELDS[@]}"; do REPORT_FIELDS[$i]=$(echo "${REPORT_FIELDS[$i]}" | xargs); done

          if [[ ${#CHECK_LIST[@]} -ne ${#NAME_FIELDS[@]} || ${#CHECK_LIST[@]} -ne ${#STATUS_FIELDS[@]} || ${#CHECK_LIST[@]} -ne ${#REPORT_FIELDS[@]} ]]; then
            echo "❌ Config error: counts do not match"
            exit 1
          fi

          # Fetch check-runs (retry because GitHub sometimes lags)
          CHECK_RUNS=""
          for attempt in {1..8}; do
            CHECK_RUNS=$(curl -sS \
              -H "Authorization: Bearer $TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${REPO}/commits/${SHA}/check-runs?per_page=100")

            total=$(echo "$CHECK_RUNS" | jq -r '.total_count // 0')
            if [[ "$total" != "0" ]]; then
              break
            fi
            sleep 5
          done

          echo "Total check_runs found: $(echo "$CHECK_RUNS" | jq -r '.total_count // 0')"

          # Store all check names + derived statuses
          ALL_CHECK_NAMES=$(echo "$CHECK_RUNS" | jq -r '.check_runs[]?.name' | paste -sd "," -)
          ALL_CHECK_STATUSES=$(echo "$CHECK_RUNS" | jq -r '
            .check_runs[]? |
            (if .status != "completed" then .status else (.conclusion // "unknown") end)
          ' | paste -sd "," -)

          echo "CHECK_NAMES_ALL=$ALL_CHECK_NAMES" >> "$GITHUB_OUTPUT"
          echo "CHECK_STATUSES_ALL=$ALL_CHECK_STATUSES" >> "$GITHUB_OUTPUT"

          SF_CHECK_FIELDS_JSON="{}"

          for i in "${!CHECK_LIST[@]}"; do
            chk="${CHECK_LIST[$i]}"
            nameField="${NAME_FIELDS[$i]}"
            statusField="${STATUS_FIELDS[$i]}"
            reportField="${REPORT_FIELDS[$i]}"

            # ✅ IMPORTANT FIX: Always select the latest check_run by numeric ID
            run=$(echo "$CHECK_RUNS" | jq -c --arg n "$chk" '
              [ .check_runs[]? | select(.name==$n) ]
              | sort_by(.id)
              | last // empty
            ')

            derivedStatus="not_found"
            artifactNames=""

            if [[ -n "$run" && "$run" != "null" ]]; then
              st=$(echo "$run" | jq -r '.status // "unknown"')
              concl=$(echo "$run" | jq -r '.conclusion // empty')
              detailsUrl=$(echo "$run" | jq -r '.details_url // empty')

              if [[ "$st" != "completed" ]]; then
                derivedStatus="$st"
              else
                derivedStatus="${concl:-unknown}"
              fi

              # ✅ Artifact name (only works if details_url contains /actions/runs/<id>)
              runId=$(echo "$detailsUrl" | sed -n 's#.*\/actions\/runs\/\([0-9]\+\).*#\1#p' | head -n 1)

              if [[ -n "$runId" ]]; then
                # Artifact API lags sometimes - retry
                for a in {1..10}; do
                  ART_JSON=$(curl -sS \
                    -H "Authorization: Bearer $TOKEN" \
                    -H "Accept: application/vnd.github.v3+json" \
                    "https://api.github.com/repos/${REPO}/actions/runs/${runId}/artifacts")

                  names=$(echo "$ART_JSON" | jq -r '.artifacts[]?.name' | paste -sd "," -)
                  if [[ -n "$names" ]]; then
                    artifactNames="$names"
                    break
                  fi
                  sleep 4
                done
              fi
            fi

            echo "Mapped: $chk -> status=$derivedStatus artifact=${artifactNames:-<null>}"

            if [[ -n "$artifactNames" ]]; then
              SF_CHECK_FIELDS_JSON=$(echo "$SF_CHECK_FIELDS_JSON" | jq \
                --arg nf "$nameField" --arg nv "$chk" \
                --arg sf "$statusField" --arg sv "$derivedStatus" \
                --arg rf "$reportField" --arg rv "$artifactNames" \
                '. + {($nf): $nv, ($sf): $sv, ($rf): $rv}')
            else
              SF_CHECK_FIELDS_JSON=$(echo "$SF_CHECK_FIELDS_JSON" | jq \
                --arg nf "$nameField" --arg nv "$chk" \
                --arg sf "$statusField" --arg sv "$derivedStatus" \
                --arg rf "$reportField" \
                '. + {($nf): $nv, ($sf): $sv, ($rf): null}')
            fi
          done

          {
            echo "SF_CHECK_FIELDS_JSON<<EOF"
            echo "$SF_CHECK_FIELDS_JSON"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          echo "✅ SF_CHECK_FIELDS_JSON:"
          echo "$SF_CHECK_FIELDS_JSON"

      - name: Check if PR Record Exists in Salesforce
        if: steps.pr_ctx.outputs.SKIP != 'true'
        id: check_existing_pr
        shell: bash
        run: |
          set -euo pipefail

          PR_LINK="${{ steps.pr_ctx.outputs.PR_LINK }}"
          SOQL="SELECT Id, PR_Reviewer__c, PR_Review_Comment__c FROM ${{ env.OBJECT_NAME }} WHERE PR_Link__c='${PR_LINK}' LIMIT 1"

          RESPONSE=$(curl -sS -G "${{ env.DOMAIN_URL }}/services/data/v61.0/query" \
            -H "Authorization: Bearer ${{ secrets.SF_ACCESS_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data-urlencode "q=${SOQL}")

          if [[ "$(echo "$RESPONSE" | jq -r 'type')" == "array" ]]; then
            echo "❌ Salesforce query failed:"
            echo "$RESPONSE" | jq -r '.[0].errorCode + ": " + .[0].message'
            exit 1
          fi

          RECORD_ID=$(echo "$RESPONSE" | jq -r '.records[0].Id // empty')
          EXISTING_REVIEWER=$(echo "$RESPONSE" | jq -r '.records[0].PR_Reviewer__c // empty')
          EXISTING_COMMENT=$(echo "$RESPONSE" | jq -r '.records[0].PR_Review_Comment__c // empty')

          echo "EXISTING_ID=$RECORD_ID" >> "$GITHUB_OUTPUT"
          echo "EXISTING_REVIEWER=$EXISTING_REVIEWER" >> "$GITHUB_OUTPUT"
          echo "EXISTING_COMMENT=$EXISTING_COMMENT" >> "$GITHUB_OUTPUT"

      - name: Send PR Information to Salesforce (Create or Update)
        if: steps.pr_ctx.outputs.SKIP != 'true'
        shell: bash
        run: |
          set -euo pipefail

          prStatus="${{ steps.pr_status_check.outputs.PR_STATUS }}"
          mergedBy="${{ steps.pr_status_check.outputs.MERGED_BY }}"
          recordId="${{ steps.check_existing_pr.outputs.EXISTING_ID }}"

          prTitle="${{ steps.pr_ctx.outputs.PR_TITLE }}"
          prLink="${{ steps.pr_ctx.outputs.PR_LINK }}"
          prAuthor="${{ steps.pr_ctx.outputs.PR_AUTHOR }}"

          newReviewer=""
          newComment=""

          if [[ "${{ github.event_name }}" == "pull_request_review" ]]; then
            newReviewer="${{ github.event.review.user.login }}"
            newComment="${{ github.event.review.body }}"
          fi

          existingReviewer="${{ steps.check_existing_pr.outputs.EXISTING_REVIEWER }}"
          existingComment="${{ steps.check_existing_pr.outputs.EXISTING_COMMENT }}"

          if [[ -n "$existingReviewer" && "$existingReviewer" != "null" ]]; then
            updatedReviewer="$existingReviewer $newReviewer"
          else
            updatedReviewer="$newReviewer"
          fi

          if [[ -n "$existingComment" && "$existingComment" != "null" ]]; then
            updatedComment="$existingComment  $newComment"
          else
            updatedComment="$newComment"
          fi

          BASE=$(jq -n \
            --arg title "$prTitle" \
            --arg link "$prLink" \
            --arg status "$prStatus" \
            --arg author "$prAuthor" \
            --arg reviewer "$updatedReviewer" \
            --arg comment "$updatedComment" \
            --arg allNames "${{ steps.fetch_checks.outputs.CHECK_NAMES_ALL }}" \
            --arg allStats "${{ steps.fetch_checks.outputs.CHECK_STATUSES_ALL }}" \
            '{
              PR_Title__c: $title,
              PR_Link__c: $link,
              PR_Status__c: $status,
              PR_Author__c: $author,
              PR_Reviewer__c: $reviewer,
              PR_Review_Comment__c: $comment,
              PR_Check_Name__c: $allNames,
              PR_Check_Status__c: $allStats
            }')

          CHECK_FIELDS_JSON='${{ steps.fetch_checks.outputs.SF_CHECK_FIELDS_JSON }}'
          PAYLOAD=$(echo "$BASE" | jq --argjson fields "$CHECK_FIELDS_JSON" '. + $fields')

          if [[ -n "$mergedBy" ]]; then
            PAYLOAD=$(echo "$PAYLOAD" | jq --arg mergedBy "$mergedBy" '. + { PR_Merged_By__c: $mergedBy }')
          fi

          if [[ -n "$recordId" ]]; then
            echo "Updating existing PR record: $recordId"
            RESPONSE=$(curl -sS -X PATCH "${{ env.DOMAIN_URL }}/services/data/v61.0/sobjects/${{ env.OBJECT_NAME }}/$recordId" \
              -H "Authorization: Bearer ${{ secrets.SF_ACCESS_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD")
          else
            echo "Creating a new PR record"
            RESPONSE=$(curl -sS -X POST "${{ env.DOMAIN_URL }}/services/data/v61.0/sobjects/${{ env.OBJECT_NAME }}/" \
              -H "Authorization: Bearer ${{ secrets.SF_ACCESS_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD")
          fi

          echo "Response: $RESPONSE"
