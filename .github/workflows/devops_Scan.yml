name: SFDX Code Scan and Store in Salesforce

on:
  push:
    branches:
      - "**"

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}-${{ github.run_id }}
  cancel-in-progress: false

jobs:
  quality-gate-code-check:
    runs-on: ubuntu-latest
    outputs:
      scanner-report-path: ${{ steps.upload-report.outputs.artifact-path }}
      block-pr: ${{ steps.block-check.outputs.block-status }}
      runner-name: ${{ steps.get-runner.outputs.runner_name }}
      commit-author: ${{ steps.commit-author.outputs.commit-author }}
      scanner-report-url: ${{ steps.upload-report.outputs.scanner-report-url }}

    steps:

      - name: Get Runner Name
        id: get-runner
        run: |
          echo "Runner: ${{ runner.name }}"
          echo "Hostname: $(hostname)"
          uname -a
          cat /etc/os-release

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20.x

      - name: Install Salesforce CLI
        run: npm install --global @salesforce/cli

      - name: Add npm global bin to PATH
        run: echo "$(npm bin -g)" >> $GITHUB_PATH

      - name: Clear CLI Plugin Cache
        run: sf plugins update

      - name: Remove old Scanner plugin
        run: |
          sf plugins uninstall @salesforce/sfdx-scanner || true
          sf plugins unlink @salesforce/sfdx-scanner || true

      - name: Install Salesforce Scanner (Correct Plugin)
        run: sf plugins install @salesforce/sfdx-scanner

      - name: Confirm Plugins Installed
        run: sf plugins --core

      - name: Verify Salesforce CLI
        run: sf --version

      - name: Get Commit Author
        id: commit-author
        run: |
          AUTHOR=$(git log -1 --pretty=format:'%an')
          echo "Commit Author: $AUTHOR"
          echo "commit-author=$AUTHOR" >> $GITHUB_OUTPUT
          echo "COMMIT_AUTHOR=$AUTHOR" >> $GITHUB_ENV

      - name: Get Repo Info
        id: get-info
        run: |
          REPO_NAME=$(echo $GITHUB_REPOSITORY | cut -d'/' -f2)
          BRANCH_NAME=$(echo $GITHUB_REF | sed 's/refs\/heads\///')
          COMMIT_LABEL=$(git log -1 --pretty=format:'%s' | tr ' ' '_')
          echo "FILE_TITLE=Code-Scan-${REPO_NAME}-${BRANCH_NAME}-${COMMIT_LABEL}" >> $GITHUB_ENV
          echo "TARGET_BRANCH=${BRANCH_NAME}" >> $GITHUB_ENV

      - name: Extract Changed Lines
        id: get-changes
        run: |
          mkdir -p temp_scanner_files
          > changed_cls_lwc_files.txt
          > line_number_mapping.txt

          changed_files=$(git diff --name-only HEAD~1 HEAD -- '*.cls' '*.js' '*.html' '*.lwc')
          echo "Changed files: $changed_files"

          if [ -z "$changed_files" ]; then
            echo "No changes detected."
            echo "Problem,Severity,File,Line,Message" > scanner-report.csv
            exit 0
          fi

          for file in $changed_files; do
            echo "Processing: $file"

            file_status=$(git diff --name-status HEAD~1 HEAD -- "$file" | awk '{print $1}')

            temp_file="temp_scanner_files/temp_${file//\//_}"
            touch "$temp_file"

            # Handle brand-new Apex class
            if [[ "$file_status" == "A" && "$file" == *.cls ]]; then
              echo "$file" >> changed_cls_lwc_files.txt
              echo "$file,ENTIRE_FILE" >> line_number_mapping.txt
              continue
            fi

            extracted=$(git diff --unified=0 HEAD~1 HEAD -- "$file" | awk '
              /^@@/ {
                match($0, /\+([0-9]+)/, arr); line=arr[1]; next
              }
              /^\+/ && $0 !~ /^(diff|index|---|\+\+\+|@@)/ {
                print line "," substr($0,2); line++
              }')

            if [ -z "$extracted" ]; then
              echo "No delta lines in $file"
              continue
            fi

            echo "$extracted" > line_number_mapping_${file//\//_}.txt

            if [[ "$file" == *.cls ]]; then
              echo "public class TempWrapperClass {" > "$temp_file"
              echo "public static void tempMethod() {" >> "$temp_file"

              while IFS=, read -r ln content; do
                trimmed=$(echo "$content" | sed 's/^ *//;s/ *$//')
                echo "$temp_file,$ln,$trimmed" >> line_number_mapping.txt
                echo "    $trimmed" >> "$temp_file"
              done < line_number_mapping_${file//\//_}.txt

              echo "}" >> "$temp_file"
              echo "}" >> "$temp_file"

            else
              while IFS=, read -r ln content; do
                trimmed=$(echo "$content")
                echo "$trimmed" >> "$temp_file"
                echo "$temp_file,$ln,$trimmed" >> line_number_mapping.txt
              done < line_number_mapping_${file//\//_}.txt
            fi

            echo "$temp_file" >> changed_cls_lwc_files.txt
          done

          echo "==== FINAL LINE NUMBER MAPPING ===="
          cat line_number_mapping.txt
      - name: Debug Line Number Mapping
        run: |
          echo "====== FINAL LINE NUMBER MAPPING ======"
          cat line_number_mapping.txt || echo "‚ùå No line mappings!"
          echo "====== CHECK FILE PATHS ======"
          ls -R temp_scanner_files

      #######################################################################
      #   ‚≠ê FIXED SFDX SCANNER SECTION (THIS WAS THE MAIN PROBLEM)        #
      #######################################################################
      - name: Run SFDX Scanner on Delta Files (Code Analyzer v5 Compatible)
        run: |
          files=$(cat changed_cls_lwc_files.txt)
          if [ -z "$files" ]; then
            echo "No files to scan."
            echo "Problem,Severity,File,Line,Message" > scanner-report.csv
            exit 0
          fi

          echo "Problem,Severity,File,Line,Message" > scanner-report.csv

          for file in $files; do
            echo "üîç Scanning file: $file"

            sf scanner run \
              --target "$file" \
              --engine pmd \
              --format json \
              --outfile scanner-report-partial.json || true

            # Parse Code Analyzer v5 JSON format
            if [ -f scanner-report-partial.json ]; then
              jq -r '
                .[]? |
                .violations[]? |
                [
                  .ruleName,
                  .severity,
                  .fileName,
                  .line,
                  .message
                ] | @csv
              ' scanner-report-partial.json >> scanner-report.csv
            fi
          done

          echo "======= FINAL SCANNER REPORT ======="
          cat scanner-report.csv


      #######################################################################
      #             SALESFORCE LOGIN (OAuth Username + Password)            #
      #######################################################################
      - name: Load Salesforce API URL
        id: load-api-url
        run: |
          API_URL=$(cat config/salesforce_api_url.txt)
          echo "API_URL=$API_URL" >> $GITHUB_ENV

      - name: Authenticate with Salesforce
        id: sf-auth
        run: |
          response=$(curl -X POST "https://login.salesforce.com/services/oauth2/token" \
            -d "grant_type=password" \
            -d "client_id=${{ secrets.SF_CLIENT_ID }}" \
            -d "client_secret=${{ secrets.SF_CLIENT_SECRET }}" \
            -d "username=${{ secrets.SF_USERNAME }}" \
            -d "password=${{ secrets.SF_PASSWORD }}${{ secrets.SF_SECURITY_TOKEN }}" )
          
          echo "Login response: $response"

          SF_ACCESS_TOKEN=$(echo "$response" | jq -r '.access_token')
          INSTANCE_URL=$(echo "$response" | jq -r '.instance_url')

          if [[ -z "$SF_ACCESS_TOKEN" || "$SF_ACCESS_TOKEN" == "null" ]]; then
            echo "‚ùå Salesforce authentication failed."
            exit 1
          fi

          echo "SF_ACCESS_TOKEN=$SF_ACCESS_TOKEN" >> $GITHUB_ENV
          echo "INSTANCE_URL=$INSTANCE_URL" >> $GITHUB_ENV
          echo "‚úÖ Salesforce Authentication Successful"

      #######################################################################
      #                     UPLOAD REPORT TO SALESFORCE                     #
      #######################################################################
      - name: Upload Scanner Report to Salesforce
        if: success()
        run: |
            violation_count=$(tail -n +2 scanner-report.csv | wc -l)
            if [ "$violation_count" -eq 0 ]; then
              echo "No violations ‚Üí Skipping Salesforce upload."
              exit 0
            fi

            echo "Uploading scanner report to Salesforce..."

            response=$(curl -X POST "$INSTANCE_URL/services/data/v58.0/sobjects/ContentVersion" \
              -H "Authorization: Bearer $SF_ACCESS_TOKEN" \
              -H "Content-Type: multipart/form-data" \
              -F "entity_content={\"Title\": \"${{ env.FILE_TITLE }}\", \"PathOnClient\": \"scanner-report.csv\"};type=application/json" \
              -F "VersionData=@scanner-report.csv;type=text/csv")

            echo "SF Response: $response"

            contentVersionId=$(echo "$response" | jq -r 'if type=="array" then .[0].id else .id end')

            if [[ "$contentVersionId" == "null" || -z "$contentVersionId" ]]; then
              echo "‚ùå Failed to extract ContentVersion ID"
              exit 1
            fi

            echo "Uploaded to Salesforce. ContentVersionId=$contentVersionId"

      #######################################################################
      #                    ENSURE REPORT EXISTS FOR EMAILS                  #
      #######################################################################
      - name: Ensure Scanner Report Exists
        if: always()
        run: |
            if [ ! -s scanner-report.csv ]; then
              echo "Creating dummy empty report."
              echo "Problem,Severity,File,Line,Message" > scanner-report.csv
            fi

      #######################################################################
      #                BACKUP REPORT TO /tmp/artifact_backup               #
      #######################################################################
      - name: Generate Unique File Name
        run: |
          LABEL=$(git log -1 --pretty=format:'%s' | tr ' ' '_')
          REPORT_FILE="${LABEL}.csv"
          echo "REPORT_FILE=$REPORT_FILE" >> $GITHUB_ENV

      - name: Backup Report
        run: |
          mkdir -p /tmp/artifact_backup
          cp scanner-report.csv /tmp/artifact_backup/${{ env.REPORT_FILE }}
          echo "Backup saved: /tmp/artifact_backup/${{ env.REPORT_FILE }}"

      #######################################################################
      #      PUSH REPORT TO SCANNER_REPORTS BRANCH (Auto-versioning)        #
      #######################################################################
      - name: Commit and Push Report to Scanner_Reports
        if: always()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH="Scanner_Reports"

          if git ls-remote --exit-code --heads origin "$BRANCH"; then
            git checkout $BRANCH
          else
            git checkout -b $BRANCH
            git push --set-upstream origin $BRANCH
          fi

          git pull origin $BRANCH --rebase

          mkdir -p Artifact
          cp /tmp/artifact_backup/${{ env.REPORT_FILE }} Artifact/${{ env.REPORT_FILE }}

          git add Artifact/${{ env.REPORT_FILE }}
          git commit -m "Auto update: ${{ env.REPORT_FILE }}" || echo "No changes"
          git push origin $BRANCH

      #######################################################################
      #                           SEND EMAILS                               #
      #######################################################################
      - name: Install mailx
        run: sudo apt-get install -y mailutils

      - name: Get Pusher Email
        id: get-pusher-email
        run: |
          SHA=${{ github.sha }}
          REPO=${{ github.repository }}

          PUSHER=$(curl -s -H "Authorization: token ${{ secrets.GH_PAT }}" \
            "https://api.github.com/repos/${REPO}/commits/${SHA}" | jq -r '.commit.committer.email')

          if [[ -z "$PUSHER" || "$PUSHER" == "null" ]]; then
            PUSHER="${{ github.event.pusher.email }}"
          fi

          if [[ "$PUSHER" =~ .*noreply.* || -z "$PUSHER" ]]; then
            PUSHER=$(git log -1 --pretty=format:'%ae')
          fi

          echo "PUSHER_EMAIL=$PUSHER" >> $GITHUB_ENV
          echo "Using pusher email: $PUSHER"

      - name: Send Email via Gmail
        uses: dawidd6/action-send-mail@v3
        continue-on-error: true
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.GMAIL_EMAIL }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          from: ${{ secrets.GMAIL_EMAIL }}
          subject: "SFDX Code Scan Delta Report"
          body: "Please find the attached SFDX Code Scan Delta Report."
          to: ${{ env.PUSHER_EMAIL }},${{ secrets.GMAIL_EMAIL }}
          attachments: scanner-report.csv

      - name: Get OAuth Token for Outlook
        id: get-oauth-token
        run: |
          RESPONSE=$(curl -X POST "https://login.microsoftonline.com/${{ secrets.OUTLOOK_TENANT_ID }}/oauth2/v2.0/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=${{ secrets.OUTLOOK_CLIENT_ID }}" \
            -d "client_secret=${{ secrets.OUTLOOK_CLIENT_SECRET }}" \
            -d "scope=https://graph.microsoft.com/.default" \
            -d "grant_type=client_credentials")

          TOKEN=$(echo $RESPONSE | jq -r '.access_token')

          if [[ "$TOKEN" == "null" ]]; then
            echo "‚ùå Failed to get Microsoft Graph token"
            exit 1
          fi

          echo "OAUTH_ACCESS_TOKEN=$TOKEN" >> $GITHUB_ENV

      - name: Send Email via Outlook
        run: |
          curl -X POST "https://graph.microsoft.com/v1.0/users/${{ secrets.OUTLOOK_EMAIL }}/sendMail" \
            -H "Authorization: Bearer $OAUTH_ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"message\": {
                \"subject\": \"SFDX Code Scan Delta Report\",
                \"body\": {\"contentType\": \"text\", \"content\": \"Report Attached\"},
                \"toRecipients\": [{\"emailAddress\": {\"address\": \"${{ secrets.OUTLOOK_EMAIL }}\"}}]
              }
            }"
      #######################################################################
      #                 BLOCK COMMIT IF SEVERITY VIOLATIONS                #
      #######################################################################
      - name: Block PR Merge if Severity Violations Found
        id: block-check
        run: |
          if [ -f scanner-report.csv ]; then
            echo "Reading scanner-report.csv..."
            cat scanner-report.csv

            # Count Apex severity 3 violations
            apex_severity=$(awk -F',' 'NR>1 { 
              s=$2; gsub(/\"/, "", s);
              f=$3; gsub(/\"/, "", f);
              if (s==3 && f ~ /\.cls$/) count++ 
            } END {print count+0}' scanner-report.csv)

            # Count LWC severity >=2
            lwc_severity=$(awk -F',' 'NR>1 {
              s=$2; gsub(/\"/, "", s);
              f=$3; gsub(/\"/, "", f);
              if (s>=2 && (f ~ /\.js$/ || f ~ /\.html$/ || f ~ /\.lwc$/)) count++
            } END {print count+0}' scanner-report.csv)

            echo "Apex Severity 3: $apex_severity"
            echo "LWC Severity >=2: $lwc_severity"

            if [ "$apex_severity" -gt 0 ] || [ "$lwc_severity" -gt 0 ]; then
              echo "block-status=true" >> $GITHUB_ENV
              echo "block-status=true" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "block-status=false" >> $GITHUB_ENV
              echo "block-status=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "scanner-report.csv missing!"
            echo "block-status=true" >> $GITHUB_ENV
            echo "block-status=true" >> $GITHUB_OUTPUT
            exit 1
          fi


  ############################################################################
  #                            SLACK NOTIFICATIONS                            #
  ############################################################################
  notify-slack:
    runs-on: ubuntu-latest
    needs: quality-gate-code-check
    if: always()

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Fetch Slack User Mapping
        env:
          SLACK_USER_MAP: ${{ secrets.SLACK_USER_MAP }}
        run: |
          AUTHOR="${{ needs.quality-gate-code-check.outputs.commit-author }}"

          if [[ -z "$SLACK_USER_MAP" ]]; then
            echo "ERROR: SLACK_USER_MAP is empty"
            exit 1
          fi

          SLACK_ID=$(echo "$SLACK_USER_MAP" | jq -r --arg user "$AUTHOR" '.[$user]')

          if [[ -z "$SLACK_ID" || "$SLACK_ID" == "null" ]]; then
            echo "AUTHOR_SLACK_ID=unknown" >> $GITHUB_ENV
          else
            echo "AUTHOR_SLACK_ID=$SLACK_ID" >> $GITHUB_ENV
          fi

      - name: Format Scanner Report for Slack
        id: format-report
        run: |
          if [ ! -s scanner-report.csv ]; then
            echo "No report for Slack"
            exit 0
          fi

          echo "```" > slack_report.txt
          echo "| Problem | Severity | File | Line | Rule | Category |" >> slack_report.txt
          echo "|---------|----------|------|------|------|----------|" >> slack_report.txt

          awk -F',' 'NR>1 && NR<=6 { printf("| %s | %s | %s | %s | %s | %s |\n",
            $1,$2,$3,$4,$6,$9) }' scanner-report.csv >> slack_report.txt

          echo "```" >> slack_report.txt

          REPORT_TABLE=$(cat slack_report.txt | jq -sR)
          echo "report_table=$REPORT_TABLE" >> $GITHUB_ENV

      - name: Send DM to Developer on Slack
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          SLACK_ID="${{ env.AUTHOR_SLACK_ID }}"
          REPORT_URL="${{ needs.quality-gate-code-check.outputs.scanner-report-url }}"
          TABLE="${{ env.report_table }}"

          if [[ "$SLACK_ID" == "unknown" ]]; then
            echo "No Slack ID, skipping DM"
            exit 0
          fi

          if [[ -z "$REPORT_URL" ]]; then
            MSG=":x: Code Scan Failed ‚Äì No report generated."
          else
            MSG="*SFDX Code Scan Completed*  
            üìÑ Report: <$REPORT_URL|Download>  
            üîç Summary:  
            $TABLE"
                  fi

                  curl -X POST \
                    -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
                    -H "Content-type: application/json" \
                    --data "{\"channel\":\"$SLACK_ID\",\"text\":$MSG}" \
                    https://slack.com/api/chat.postMessage

      - name: Post Result in Slack Channel
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          URL="${{ needs.quality-gate-code-check.outputs.scanner-report-url }}"
          AUTHOR="${{ needs.quality-gate-code-check.outputs.commit-author }}"
          REPO=$(echo $GITHUB_REPOSITORY | cut -d'/' -f2)
          BRANCH=$(echo $GITHUB_REF | sed 's/refs\/heads\///')

          if [[ -n "$URL" ]]; then
            MSG="*SFDX Code Scan Completed*  
          üìÅ Repo: $REPO  
          üåø Branch: $BRANCH  
          üë§ Author: $AUTHOR  
          üîó <${URL}|Download Scanner Report>"
                    else
                      MSG=":x: Scan Failed ‚Äì No report generated  
          üìÅ Repo: $REPO  
          üåø Branch: $BRANCH  
          üë§ Author: $AUTHOR"
                    fi

                    curl -X POST -H 'Content-type: application/json' \
                      --data "{\"text\": \"$MSG\"}" \
                      "$SLACK_WEBHOOK_URL"


  ############################################################################
  #                     CRITICAL PERMISSION SET CHECK                         #
  ############################################################################
  quality-gate-critical-permissions-check:
    runs-on: ubuntu-latest
    needs: quality-gate-code-check
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changed-files
        run: |
          git diff --name-only HEAD^ HEAD > changed_files.txt
          touch filtered_files.txt
          grep -E 'force-app/main/default/(profiles|permissionsets)/.*\.(profile|permissionset)-meta\.xml' changed_files.txt > filtered_files.txt || echo ""

      - name: Scan for Critical Permissions
        run: |
          CRITICAL_PERMS=(
            "AssignPermissionSets"
            "AuthorApex"
            "CustomizeApplication"
            "FreezeUsers"
            "ManageEncryptionKeys"
            "ManageInternalUsers"
            "ManagePasswordPolicies"
            "ManageProfilesPermissionSets"
            "ManageRoles"
            "ManageSharing"
            "ManageUsers"
            "ModifyAllData"
            "MonitorLoginHistory"
            "MultiFactorAuthenticationRequired"
            "PasswordNeverExpires"
            "ResetPasswordsUnlockUsers"
            "ViewAllData"
          )

          BLOCKED=()

          while IFS= read -r FILE; do
            [[ -z "$FILE" ]] && continue

            for PERM in "${CRITICAL_PERMS[@]}"; do
              if grep -q "$PERM" "$FILE"; then
                BLOCKED+=("$FILE")
              fi
            done

          done < filtered_files.txt

          if [ ${#BLOCKED[@]} -gt 0 ]; then
            echo "CRITICAL PERMISSIONS FOUND:"
            for f in "${BLOCKED[@]}"; do echo "$f"; done
            exit 1
          else
            echo "No critical permissions found."
          fi
