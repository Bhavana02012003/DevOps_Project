name: Notify Slack on PR Assignment and Review

on:
  pull_request:
    types:
      - assigned
      - review_requested

  pull_request_review:
    types:
      - submitted

jobs:
  notify_slack:
    runs-on: ubuntu-latest

    steps:
      - name: Get Slack User Mapping
        env:
          SLACK_USER_MAP: ${{ secrets.SLACK_USER_MAP }}
          REVIEWER_GITHUB: "${{ github.event.requested_reviewer.login || github.event.assignee.login }}"
          AUTHOR_GITHUB: "${{ github.event.pull_request.user.login }}"
        run: |
          echo "Fetching Slack IDs for users..."
          
          echo "DEBUG: GitHub username of assigned reviewer = $REVIEWER_GITHUB"
          echo "DEBUG: GitHub username of PR author = $AUTHOR_GITHUB"

          # Extract Slack ID for the assigned reviewer
          REVIEWER_SLACK_ID=$(echo "$SLACK_USER_MAP" | jq -r --arg user "$REVIEWER_GITHUB" '.[$user]')
          
          # Extract Slack ID for the PR author
          AUTHOR_SLACK_ID=$(echo "$SLACK_USER_MAP" | jq -r --arg user "$AUTHOR_GITHUB" '.[$user]')

          echo "DEBUG: Reviewer's Slack ID = $REVIEWER_SLACK_ID"
          echo "DEBUG: Author's Slack ID = $AUTHOR_SLACK_ID"

          echo "REVIEWER_SLACK_ID=$REVIEWER_SLACK_ID" >> $GITHUB_ENV
          echo "AUTHOR_SLACK_ID=$AUTHOR_SLACK_ID" >> $GITHUB_ENV

      - name: Debug GitHub Payload
        run: |
          echo "Printing full GitHub event payload:"
          echo '${{ toJson(github.event) }}'

      - name: Debug Slack User Map
        env:
          SLACK_USER_MAP: ${{ secrets.SLACK_USER_MAP }}
        run: |
          echo "Printing full Slack User Map JSON:"
          echo "$SLACK_USER_MAP"

      # ğŸ“¢ Send Slack Notification to Channel for PR Assignment
      - name: Send Slack Channel Notification on PR Assignment
        if: github.event.action == 'assigned' || github.event.action == 'review_requested'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
          PR_NUMBER: "${{ github.event.pull_request.number }}"
          PR_TITLE: "${{ github.event.pull_request.title }}"
          PR_URL: "${{ github.event.pull_request.html_url }}"
          PR_AUTHOR: "${{ github.event.pull_request.user.login }}"
          REVIEWER: "${{ github.event.requested_reviewer.login || github.event.assignee.login }}"
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "text": ":wave: *PR Review Requested in the Channel!*\n\nğŸ“Œ *Title:* '"$PR_TITLE"'\nğŸ”¢ *PR Number:* #'"$PR_NUMBER"'\nğŸ“ *Author:* '"$PR_AUTHOR"'\nğŸ‘¤ *Assigned to:* '"$REVIEWER"'\nğŸ”— *PR Link:* '"$PR_URL"'"
          }' "$SLACK_WEBHOOK_URL"

      # ğŸ“¢ Send Slack DM to Assigned Reviewer
      - name: Send Slack DM to Assigned Reviewer
        if: github.event.action == 'assigned' || github.event.action == 'review_requested'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          PR_NUMBER: "${{ github.event.pull_request.number }}"
          PR_TITLE: "${{ github.event.pull_request.title }}"
          PR_URL: "${{ github.event.pull_request.html_url }}"
          PR_AUTHOR: "${{ github.event.pull_request.user.login }}"
        run: |
          if [ -n "$REVIEWER_SLACK_ID" ] && [ "$REVIEWER_SLACK_ID" != "null" ]; then
            curl -X POST -H "Authorization: Bearer $SLACK_BOT_TOKEN" -H "Content-type: application/json" \
            --data '{
              "channel": "'"$REVIEWER_SLACK_ID"'",
              "text": ":wave: *You have been assigned a PR for review!*\n\nğŸ“Œ *Title:* '"$PR_TITLE"'\nğŸ”¢ *PR Number:* #'"$PR_NUMBER"'\nğŸ“ *Author:* '"$PR_AUTHOR"'\nğŸ”— *PR Link:* '"$PR_URL"'"
            }' https://slack.com/api/chat.postMessage
          fi

      # ğŸ“¢ Send Slack Channel Notification on PR Review Submission
      - name: Send Slack Channel Notification on PR Review Submission
        if: github.event_name == 'pull_request_review' && github.event.action == 'submitted'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
          PR_NUMBER: "${{ github.event.pull_request.number }}"
          PR_TITLE: "${{ github.event.pull_request.title }}"
          PR_URL: "${{ github.event.pull_request.html_url }}"
          PR_AUTHOR: "${{ github.event.pull_request.user.login }}"
          REVIEWER: "${{ github.event.review.user.login }}"
          REVIEW_STATE: "${{ github.event.review.state }}"
          REVIEW_BODY: "${{ github.event.review.body }}"
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "text": ":speech_balloon: *PR Review Submitted in the Channel!*\n\nğŸ“Œ *Title:* '"$PR_TITLE"'\nğŸ”¢ *PR Number:* #'"$PR_NUMBER"'\nğŸ“ *Author:* '"$PR_AUTHOR"'\nğŸ‘¤ *Reviewed by:* '"$REVIEWER"'\nğŸ“„ *Review State:* '"$REVIEW_STATE"'\nğŸ’¬ *Comments:* '"$REVIEW_BODY"'\nğŸ”— *PR Link:* '"$PR_URL"'"
          }' "$SLACK_WEBHOOK_URL"

      # ğŸ“¢ Send Slack DM to PR Author on Review Submission
      - name: Send Slack DM to PR Author on Review Submission
        if: github.event_name == 'pull_request_review' && github.event.action == 'submitted'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          PR_NUMBER: "${{ github.event.pull_request.number }}"
          PR_TITLE: "${{ github.event.pull_request.title }}"
          PR_URL: "${{ github.event.pull_request.html_url }}"
          REVIEWER: "${{ github.event.review.user.login }}"
          REVIEW_STATE: "${{ github.event.review.state }}"
          REVIEW_BODY: "${{ github.event.review.body }}"
        run: |
          if [ -n "$AUTHOR_SLACK_ID" ] && [ "$AUTHOR_SLACK_ID" != "null" ]; then
            curl -X POST -H "Authorization: Bearer $SLACK_BOT_TOKEN" -H "Content-type: application/json" \
            --data '{
              "channel": "'"$AUTHOR_SLACK_ID"'",
              "text": ":speech_balloon: *Your PR has been reviewed!*\n\nğŸ“Œ *Title:* '"$PR_TITLE"'\nğŸ”¢ *PR Number:* #'"$PR_NUMBER"'\nğŸ‘¤ *Reviewed by:* '"$REVIEWER"'\nğŸ“„ *Review State:* '"$REVIEW_STATE"'\nğŸ’¬ *Comments:* '"$REVIEW_BODY"'\nğŸ”— *PR Link:* '"$PR_URL"'"
            }' https://slack.com/api/chat.postMessage
          fi
